<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <title>Nodeopixxl</title>
  </head>
  <body>
    <input type="file" />
    <br />
    <canvas></canvas>
    <br />
    <button disabled id="use-image">Bild verwenden</button>
    <button disabled id="start-image">Start</button>
    <button disabled id="stop-image">Stop</button>
  </body>
  <script>

    const fileInput = document.querySelector('input[type=file]');
    const canvas = document.querySelector('canvas');
    const useImageButton = document.querySelector('#use-image');
    const startButton = document.querySelector('#start-image');
    const stopButton = document.querySelector('#stop-image');
    const img = new Image();
    const reader = new FileReader();
    const ctx = canvas.getContext('2d');

    const out = (res) => {
      res.text()
        .then(body => console.log(body))
        .catch(err => {
          console.error(err)
        });
    };

    fileInput.addEventListener('change', (ev) => {
      ev.preventDefault();
      useImageButton.disabled = true;
      startButton.disabled = true;
      stopButton.disabled = true;

      reader.onload = (ev) => {
        if(ev.target.readyState === FileReader.DONE) {
          img.onload = () => {
            canvas.width = img.naturalWidth / img.naturalHeight * 160;
            canvas.height = 160;

            canvas.style.width = `${canvas.width}px`;
            canvas.style.height = `${canvas.height}px`;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            useImageButton.disabled = false;
            startButton.disabled = false;
            stopButton.disabled = false;
          };
          img.src = ev.target.result;
        }
      };

      reader.readAsDataURL(fileInput.files[0]);
    });


    useImageButton.addEventListener('click', () => {
      const form = new FormData();
      form.append('image', fileInput.files[0]);
      fetch('/newfile', {
        method: 'POST',
        body: form,
      })
        .then(out);
    });

    startButton.addEventListener('click', () => {
      fetch('/control/start').then(out);
    });

    stopButton.addEventListener('click', () => {
      fetch('/control/stop').then(out);
    });

  </script>
</html>
